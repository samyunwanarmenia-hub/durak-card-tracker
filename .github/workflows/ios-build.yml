name: iOS Build

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Тип сборки'
        required: true
        default: 'development'
        type: choice
        options:
          - development
          - ad-hoc

jobs:
  build:
    runs-on: macos-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          if [ $? -ne 0 ]; then
            echo "Ошибка установки зависимостей"
            exit 1
          fi

      - name: Build web assets
        run: |
          npm run build
          if [ $? -ne 0 ]; then
            echo "Ошибка сборки веб-версии"
            exit 1
          fi

      - name: Install Capacitor CLI
        run: npm install -g @capacitor/cli@latest

      - name: Add iOS platform
        run: |
          if [ ! -d "ios" ]; then
            echo "Добавляем iOS платформу..."
            npx cap add ios
            if [ $? -ne 0 ]; then
              echo "Ошибка добавления iOS платформы"
              exit 1
            fi
          else
            echo "iOS платформа уже существует"
          fi

      - name: Install CocoaPods dependencies
        run: |
          cd ios/App
          if [ -f "Podfile" ]; then
            pod install --repo-update
            if [ $? -ne 0 ]; then
              echo "Ошибка установки CocoaPods зависимостей"
              exit 1
            fi
          else
            echo "Podfile не найден, пропускаем установку CocoaPods"
          fi

      - name: Sync Capacitor
        run: |
          npx cap sync ios
          if [ $? -ne 0 ]; then
            echo "Ошибка синхронизации Capacitor"
            exit 1
          fi

      - name: Setup certificates and provisioning profile
        id: setup_certs
        env:
          IOS_CERTIFICATE_BASE64: ${{ secrets.IOS_CERTIFICATE_BASE64 }}
          IOS_CERTIFICATE_PASSWORD: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
          IOS_PROVISIONING_PROFILE_BASE64: ${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}
        run: |
          set -e
          
          # Проверяем наличие секретов
          if [ -z "$IOS_CERTIFICATE_BASE64" ]; then
            echo "Ошибка: IOS_CERTIFICATE_BASE64 не установлен"
            exit 1
          fi
          
          if [ -z "$IOS_CERTIFICATE_PASSWORD" ]; then
            echo "Ошибка: IOS_CERTIFICATE_PASSWORD не установлен"
            exit 1
          fi
          
          if [ -z "$IOS_PROVISIONING_PROFILE_BASE64" ]; then
            echo "Ошибка: IOS_PROVISIONING_PROFILE_BASE64 не установлен"
            exit 1
          fi
          
          # Создаем директории для сертификатов
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          mkdir -p ~/certificates
          
          # Декодируем и устанавливаем сертификат разработчика
          echo "$IOS_CERTIFICATE_BASE64" | base64 --decode > ~/certificates/certificate.p12
          
          if [ ! -f ~/certificates/certificate.p12 ]; then
            echo "Ошибка: не удалось декодировать сертификат"
            exit 1
          fi
          
          # Удаляем старый keychain если существует
          security delete-keychain build.keychain 2>/dev/null || true
          
          # Создаем keychain для сертификата
          security create-keychain -p "" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "" build.keychain
          security set-keychain-settings -t 3600 -u build.keychain
          
          # Импортируем сертификат
          security import ~/certificates/certificate.p12 -k build.keychain -P "$IOS_CERTIFICATE_PASSWORD" -T /usr/bin/codesign -T /usr/bin/security || {
            echo "Ошибка импорта сертификата"
            exit 1
          }
          
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "" build.keychain
          
          # Декодируем и устанавливаем provisioning profile
          echo "$IOS_PROVISIONING_PROFILE_BASE64" | base64 --decode > ~/certificates/profile.mobileprovision
          
          if [ ! -f ~/certificates/profile.mobileprovision ]; then
            echo "Ошибка: не удалось декодировать provisioning profile"
            exit 1
          fi
          
          # Получаем UUID из provisioning profile
          UUID=$(grep -aA1 UUID ~/certificates/profile.mobileprovision | grep -o "[-A-Z0-9]\{36\}" | head -1)
          
          if [ -z "$UUID" ]; then
            echo "Ошибка: не удалось извлечь UUID из provisioning profile"
            exit 1
          fi
          
          echo "PROFILE_UUID=$UUID" >> $GITHUB_ENV
          echo "Найден UUID профиля: $UUID"
          
          # Копируем provisioning profile в нужную директорию
          cp ~/certificates/profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/$UUID.mobileprovision
          
          echo "Сертификаты и профиль успешно настроены"

      - name: Verify Xcode project structure
        run: |
          if [ ! -d "ios/App" ]; then
            echo "Ошибка: директория ios/App не найдена"
            exit 1
          fi
          
          cd ios/App
          
          if [ ! -f "App.xcworkspace/contents.xcworkspacedata" ] && [ ! -f "App.xcodeproj/project.pbxproj" ]; then
            echo "Ошибка: Xcode проект не найден"
            exit 1
          fi
          
          # Определяем workspace или project
          if [ -f "App.xcworkspace/contents.xcworkspacedata" ]; then
            echo "WORKSPACE_PATH=App.xcworkspace" >> $GITHUB_ENV
            echo "BUILD_TYPE=workspace"
          else
            echo "PROJECT_PATH=App.xcodeproj" >> $GITHUB_ENV
            echo "BUILD_TYPE=project"
          fi
          
          echo "BUILD_TYPE=$BUILD_TYPE" >> $GITHUB_ENV

      - name: Build iOS app
        env:
          IOS_TEAM_ID: ${{ secrets.IOS_TEAM_ID }}
        run: |
          set -e
          
          if [ -z "$IOS_TEAM_ID" ]; then
            echo "Ошибка: IOS_TEAM_ID не установлен"
            exit 1
          fi
          
          if [ -z "$PROFILE_UUID" ]; then
            echo "Ошибка: PROFILE_UUID не установлен"
            exit 1
          fi
          
          cd ios/App
          mkdir -p build
          
          # Определяем команду сборки в зависимости от типа проекта
          if [ "$BUILD_TYPE" == "workspace" ]; then
            echo "Сборка через workspace..."
            xcodebuild clean archive \
              -workspace App.xcworkspace \
              -scheme App \
              -archivePath build/App.xcarchive \
              -configuration Release \
              CODE_SIGN_IDENTITY="Apple Development" \
              DEVELOPMENT_TEAM="$IOS_TEAM_ID" \
              PROVISIONING_PROFILE_SPECIFIER="$PROFILE_UUID" \
              -allowProvisioningUpdates \
              -quiet
          else
            echo "Сборка через project..."
            xcodebuild clean archive \
              -project App.xcodeproj \
              -scheme App \
              -archivePath build/App.xcarchive \
              -configuration Release \
              CODE_SIGN_IDENTITY="Apple Development" \
              DEVELOPMENT_TEAM="$IOS_TEAM_ID" \
              PROVISIONING_PROFILE_SPECIFIER="$PROFILE_UUID" \
              -allowProvisioningUpdates \
              -quiet
          fi
          
          if [ ! -d "build/App.xcarchive" ]; then
            echo "Ошибка: архив не создан"
            exit 1
          fi
          
          echo "Архив успешно создан"

      - name: Create export options plist
        run: |
          set -e
          
          cd ios/App
          mkdir -p build
          
          if [ "${{ github.event.inputs.build_type }}" == "ad-hoc" ]; then
            EXPORT_METHOD="ad-hoc"
          else
            EXPORT_METHOD="development"
          fi
          
          cat > build/ExportOptions.plist <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>$EXPORT_METHOD</string>
            <key>teamID</key>
            <string>${{ secrets.IOS_TEAM_ID }}</string>
            <key>compileBitcode</key>
            <false/>
          </dict>
          </plist>
          EOF
          
          echo "ExportOptions.plist создан для метода: $EXPORT_METHOD"

      - name: Export IPA
        run: |
          set -e
          
          cd ios/App
          
          if [ ! -d "build/App.xcarchive" ]; then
            echo "Ошибка: архив не найден"
            exit 1
          fi
          
          if [ ! -f "build/ExportOptions.plist" ]; then
            echo "Ошибка: ExportOptions.plist не найден"
            exit 1
          fi
          
          mkdir -p build/ipa
          
          xcodebuild -exportArchive \
            -archivePath build/App.xcarchive \
            -exportPath build/ipa \
            -exportOptionsPlist build/ExportOptions.plist \
            -allowProvisioningUpdates
          
          # Проверяем наличие .ipa файла
          IPA_FILE=$(find build/ipa -name "*.ipa" | head -1)
          
          if [ -z "$IPA_FILE" ]; then
            echo "Ошибка: .ipa файл не создан"
            ls -la build/ipa/
            exit 1
          fi
          
          echo "IPA файл успешно создан: $IPA_FILE"

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-app
          path: ios/App/build/ipa/*.ipa
          retention-days: 30
          if-no-files-found: error

